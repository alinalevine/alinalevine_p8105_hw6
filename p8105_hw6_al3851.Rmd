---
title: "p8105_hw6_al3851"
author: "Alina Levine"
date: "November 19, 2018"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(leaps)
```



```{r clean data}

homicide_df = read_csv("./Data/homicide-data.csv") %>%
  mutate(city_state = str_c(city, state, sep = ",")) %>%
  mutate(disposition = recode(disposition, `Closed without arrest` = "unsolved", `Open/No arrest` = "unsolved",    `Closed by arrest` = "solved")) %>%
  mutate(disposition = fct_relevel(disposition, "unsolved")) %>%
  mutate(disposition  = factor(disposition)) %>%
  filter(!(city_state %in% c("Dallas,TX", "Phoenix,AZ", "Kansas City,MO", "Tulsa,AL"))) %>%
  mutate(victim_race = ifelse(victim_race == "White", "white", "non-white")) %>%
  mutate(victim_race = factor(victim_race, levels = c("white", "non-white"))) %>%
  mutate(victim_age = as.numeric(victim_age)) %>%
  select(city_state, victim_sex, victim_race, victim_age,disposition)
  

```


```{r baltimore}
 baltimore_glm = homicide_df %>%
  filter(city_state == "Baltimore,MD") %>%
  glm(disposition ~ victim_sex + victim_race+victim_age , data = ., family = binomial())


est_CI_balt = baltimore_glm %>%
  broom::tidy(confint(.)) %>%
  filter(term == "victim_racenon-white") %>%
  select(estimate, conf.low,conf.high) %>%
  mutate(estimate = exp(estimate),
         conf.low = exp(conf.low),
         conf.high = exp(conf.high))

#A non-white person has .44 times the odds of a homicide being solved than a white person

```

```{r}

homicide_df %>%
  group_by(city_state) %>%
  summarize(race_factors = length(unique(victim_race)),
            disposition_factors = length(unique(disposition)),
            sex_factors = length(unique(victim_sex))) %>% View()
  




```


```{r}
homicide_df %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(regression = map(data, exp() %>% ~broom::tidy(confint(glm(disposition ~ victim_sex + victim_age + victim_race, data = .x, family = binomial()))))) %>%
  select(city_state, regression) %>%
  unnest() %>% View()


all_city_estimates = homicide_df %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(confint = map(data,~confint(glm(disposition ~ victim_sex + victim_age + victim_race, data = .x, family = binomial()))),
      confint = map(confint, broom::tidy),
      regression = map(data, ~glm(disposition ~ victim_sex + victim_age + victim_race, data = .x, family = binomial())),
      regression = map(regression, broom::tidy)) %>%
  select(city_state, regression, confint) %>%
  unnest() %>%
  select(city_state,term, estimate,X2.5..,X97.5..) %>%
  filter(term == "victim_racenon-white") %>%
  mutate(estimate = exp(estimate),
         X2.5.. = exp(X2.5..),
         X97.5.. = exp(X97.5..)) %>%
  rename(conf_low = X2.5..,
         conf_high = X97.5..) %>%
  select(-term)

all_city_estimates %>%
  mutate(city_state = fct_reorder(city_state, estimate)) %>%
  ggplot(aes( x = city_state, y = estimate )) +
    geom_errorbar(aes(ymin = conf_low, ymax = conf_high), width = .1) +
    geom_point() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(title = "Solved Homicides Ratio: nonwhite:white",
         x = "city",
         y = "estimate")

```

#ppbmi is very highly correlated with weight, so I am removing this variable. ppwt is very highly correlated with delivery weight, so I am also removing that. Additionally, there is only 1 value for pnumlbw and pnumsga
```{r data cleaning, results = "hide", message = FALSE, warning = FALSE}

birthweight_df = read_csv("./Data/birthweight.csv") %>%
  mutate(babysex = factor(babysex),
         frace = factor(frace),
         malform = factor(malform),
         mrace = factor(mrace),
         )
  select(-c(pnumlbw, pnumsga, ppbmi, ppwt))  

birthweight_df %>%
  skimr::skim()

birthweight_df %>%
  select_if(is.numeric) %>%
  cor %>% View()

birthweight_df = birthweight_df %>%
  select(-c(pnumlbw, pnumsga, ppbmi, ppwt))

#no missing data

```


I am using the model with the lowest BIC to choose my model. I am plotting the combination of variables that produces the lowest BIC for each number of possible predictors. 
```{r BIC criteria, results = "hide", message = FALSE, warning = FALSE}

leaps_birthweight = regsubsets(bwt~., data = birthweight_df, nbest = 1, nvmax= 16)
plot(leaps_birthweight)

```

This plot shows that including sex of the baby, head circumference, length of baby, mother's weight at delivery, father's race, mother's race, gestational weeks, mother's height, parity, number of cigarettes, and weightgain. 

```{r fit my model}
fit_birthweight = lm(bwt~babysex + bhead + blength + delwt + frace + mrace + gaweeks + mheight + wtgain + smoken, data = birthweight_df)
```




babysex: baby’s sex (male = 1, female = 2)
bhead: baby’s head circumference at birth (centimeters)
blength: baby’s length at birth (centimeteres)
bwt: baby’s birth weight (grams)
delwt: mother’s weight at delivery (pounds)
fincome: family monthly income (in hundreds, rounded)
frace: father’s race (1= White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other, 9 = Unknown)
gaweeks: gestational age in weeks
malform: presence of malformations that could affect weight (0 = absent, 1 = present)
menarche: mother’s age at menarche (years)
mheigth: mother’s height (inches)
momage: mother’s age at delivery (years)
mrace: mother’s race (1= White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other)
parity: number of live births prior to this pregnancy
pnumlbw: previous number of low birth weight babies
pnumgsa: number of prior small for gestational age babies
ppbmi: mother’s pre-pregnancy BMI
ppwt: mother’s pre-pregnancy weight (pounds)
smoken: average number of cigarettes smoked per day during pregnancy
wtgain: mother’s weight gain during pregnancy (pounds)

```{r residuals versus fitting value plots}

  
birthweight_pred = add_predictions(birthweight_df, fit_birthweight)
birthweight_pred_res = add_residuals(birthweight_pred, fit_birthweight)

birthweight_df %>% 
  modelr::add_residuals(fit_birthweight) %>% 
  modelr::add_predictions(fit_birthweight) %>%
  ggplot(aes(x = pred, y = resid)) +
    geom_point()



```

This does not look like a great model because the error variance is not constant over the predicted values. The error gets very high as predicted values get to the lower extremes. However, I looked at the plots of subsets of the variables I chose, and the same phenomena happened for these subsets as well. 

##Comparison Models

```{r comparison models, results = "hide", message = FALSE, warning = FALSE}

fit_simple = lm(bwt ~ blength + gaweeks, data = birthweight_df)
fit_interactions = lm(bwt~ (bhead + blength + babysex)^3, data = birthweight_df)


```

#Cross Validation comparisons 

```{r cross validation, results = "hide", message = FALSE, warning = FALSE}

cv_birthweight = 
  crossv_mc(birthweight_df, n = 100) %>%
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble)) %>%
  mutate(my_mod    = map(train, ~lm(bwt ~ babysex + bhead + blength + delwt + frace + mrace + gaweeks + mheight + wtgain + smoken, data = .x)),
         simple_mod = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
         interactions_mod = map(train, ~lm(bwt~ (bhead + blength + babysex)^3, data = .x))) %>% 
  mutate(rmse_my_mod  = map2_dbl(my_mod, test, ~rmse(model = .x, data = .y)),
         rmse_simple_mod = map2_dbl(simple_mod, test, ~rmse(model = .x, data = .y)),
         rmse_interactions_mod = map2_dbl(interactions_mod, test, ~rmse(model = .x, data = .y)))
```


```{r compare rmse, results = "hide", warning = FALSE, message = FALSE}

cv_birthweight %>%
  select(rmse_my_mod, rmse_simple_mod, rmse_interactions_mod) %>%
  unnest() %>%
  gather(key = "model", value = "rmse") %>%
  mutate(model = str_replace(model, "rmse_", "")) %>%
  ggplot(aes( x = model, y = rmse)) +
    geom_boxplot()


```

The box plots that plot the rmse for each split of the dataset show that my model performs better than the the model that uses cicumference, length, sex and all interactions and the model that uses length at birth and gestational age, as the distribution of rmse values is lower. The worst performing model is the model only using length at birth and gestational age because its disribution of rmse values is highest.  
